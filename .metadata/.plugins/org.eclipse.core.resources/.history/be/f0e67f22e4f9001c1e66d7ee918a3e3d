package com.jdbcdemo.jdbcdemo.coreCall;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Date;

import org.springframework.stereotype.Component;
import org.springframework.stereotype.Service;

import com.jdbcdemo.jdbcdemo.dto.BaseOutput;
import com.jdbcdemo.jdbcdemo.dto.EmployeeDetails;
import com.jdbcdemo.jdbcdemo.dto.EmployeeDetailsResponse;
import com.jdbcdemo.jdbcdemo.dto.InsertEmployeeList;
import com.jdbcdemo.jdbcdemo.dto.InsertEmployeeResponse;
import com.jdbcdemo.jdbcdemo.properties.PropertyClass;

import connection.ConnectionClass;
import utility.Utility;

@Service
public class CoreServiceCall {

	
	public EmployeeDetailsResponse getEmployeeLists(String empId) {

		EmployeeDetailsResponse response = new EmployeeDetailsResponse();
		BaseOutput baseOutput = new BaseOutput();

		ArrayList<EmployeeDetails> employeeDetails = new ArrayList<>();
		String errorDesc = "";
		int errorCode = 0;

		String details = "";
		baseOutput.setErrorCode(0);
		baseOutput.setErrorDesc("Success");

		// Load Oracle JDBC Driver
		try {
			DriverManager.registerDriver(new oracle.jdbc.driver.OracleDriver());

			// Connect to Oracle Database
			Connection conn = null;
			try {
				conn = ConnectionClass.getEDBConnection();
			} catch (ClassNotFoundException e1) {
				// TODO Auto-generated catch block
				e1.printStackTrace();
			}

			Statement cstmt = conn.createStatement();
			CallableStatement st = null;
			if (conn != null) {
				try {
					st = conn.prepareCall("{call dev.getEmployeesByDeptId(?,?,?,?)}");
					st.setString(1, empId);
					st.registerOutParameter(2, java.sql.Types.VARCHAR);
					st.registerOutParameter(3, java.sql.Types.DOUBLE);
					st.registerOutParameter(4, java.sql.Types.VARCHAR);
					st.execute();
					details = st.getString(2);
					errorCode = (int) st.getLong(3);
					errorDesc = st.getString(4);

				} catch (Exception e) {
					// TODO Auto-generated catch block
					st.close();
					e.printStackTrace();
				}
			}

			System.err.println(details);

			// Execute a SELECT query on Oracle Dummy DUAL Table. Useful for retrieving
			// system values
			// Enables us to retrieve values as if querying from a table
			ResultSet rs = cstmt.executeQuery("SELECT SYSDATE FROM DUAL");

			if (rs.next()) {
				Date currentDate = rs.getDate(1); // get first column returned
				System.out.println("Current Date from Oracle is : " + currentDate);
			}
			rs.close();
			cstmt.close();
			conn.close();
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		EmployeeDetails em = new EmployeeDetails();

		/*Utility ob =new Utility();
		employeeDetails = ob.changeData(details, "##", em);
*/
		String D1[] = details.split("##");
		for (int i = 0; i < D1.length; i++) {

			EmployeeDetails emp = new EmployeeDetails();

			String D2[] = D1[i].split("~~");

			System.out.println(D2[0]);

			emp.setEmpId(D2[0]);
			emp.setName(D2[1]);
			emp.setSalary(Long.valueOf(D2[2]));
			employeeDetails.add(emp);

		}

		System.out.println(employeeDetails);

		response.setEmployeeDetails(employeeDetails);
		response.setErrorCode(0);
		response.setErrorDesc("Success");

		return response;
	}

	public String insertNewEmployee(ArrayList<InsertEmployeeList> employeeList) {
		// TODO Auto-generated method stub
		return null;
	}

}
