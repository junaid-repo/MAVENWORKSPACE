package com.jdbcdemo.jdbcdemo.coreCall;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Date;

import com.jdbcdemo.jdbcdemo.dto.BaseOutput;
import com.jdbcdemo.jdbcdemo.dto.EmployeeDetails;
import com.jdbcdemo.jdbcdemo.dto.EmployeeDetailsResponse;
import com.jdbcdemo.jdbcdemo.dto.InsertEmployeeList;
import com.jdbcdemo.jdbcdemo.dto.InsertEmployeeResponse;
import com.jdbcdemo.jdbcdemo.properties.PropertyClass;

public class BaseServicesCall {

	public EmployeeDetailsResponse getEmployeeLists(String empId) {

		EmployeeDetailsResponse response = new EmployeeDetailsResponse();
		BaseOutput baseOutput = new BaseOutput();

		ArrayList<EmployeeDetails> employeeDetails = new ArrayList<>();
		String errorDesc = "";
		int errorCode = 0;

		String details = "";
		baseOutput.setErrorCode(0);
		baseOutput.setErrorDesc("Success");

		// Load Oracle JDBC Driver
		try {
			DriverManager.registerDriver(new oracle.jdbc.driver.OracleDriver());

			// Connect to Oracle Database
			Connection con = DriverManager.getConnection(PropertyClass.DBURL, PropertyClass.DBUSER,
					PropertyClass.DBPASS);

			Statement cstmt = con.createStatement();
			CallableStatement st = null;
			if (con != null) {
				try {
					st = con.prepareCall("{call dev.getEmployeesByDeptId(?,?,?,?)}");
					st.setString(1, empId);
					st.registerOutParameter(2, java.sql.Types.VARCHAR);
					st.registerOutParameter(3, java.sql.Types.DOUBLE);
					st.registerOutParameter(4, java.sql.Types.VARCHAR);
					st.execute();
					details = st.getString(2);
					errorCode = (int) st.getLong(3);
					errorDesc = st.getString(4);

				} catch (Exception e) {
					// TODO Auto-generated catch block
					st.close();
					e.printStackTrace();
				}
			}

			System.err.println(details);

			// Execute a SELECT query on Oracle Dummy DUAL Table. Useful for retrieving
			// system values
			// Enables us to retrieve values as if querying from a table
			ResultSet rs = cstmt.executeQuery("SELECT SYSDATE FROM DUAL");

			if (rs.next()) {
				Date currentDate = rs.getDate(1); // get first column returned
				System.out.println("Current Date from Oracle is : " + currentDate);
			}
			rs.close();
			cstmt.close();
			con.close();
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}

		String D1[] = details.split("##");
		for (int i = 0; i < D1.length; i++) {

			EmployeeDetails emp = new EmployeeDetails();

			String D2[] = D1[i].split("~~");

			System.out.println(D2[0]);

			emp.setEmpId(D2[0]);
			emp.setName(D2[1]);
			emp.setSalary(Long.valueOf(D2[2]));
			employeeDetails.add(emp);

		}

		/*
		 * EmployeeDetails emp = new EmployeeDetails(); EmployeeDetails emp1 = new
		 * EmployeeDetails(); EmployeeDetails emp2 = new EmployeeDetails();
		 * EmployeeDetails emp3 = new EmployeeDetails(); EmployeeDetails emp4 = new
		 * EmployeeDetails(); emp.setEmpId("124"); emp.setName("Raj Kumar");
		 * emp.setSalary(30000);
		 * 
		 * emp1.setEmpId("632"); emp1.setName("Amit Kujur"); emp1.setSalary(39000);
		 * 
		 * emp2.setEmpId("242"); emp2.setName("Sourav Ach"); emp2.setSalary(29400);
		 * 
		 * emp3.setEmpId("489"); emp3.setName("Suman Mishra"); emp3.setSalary(54003);
		 * 
		 * emp4.setEmpId("539"); emp4.setName("Harsh Ranjan"); emp4.setSalary(56993);
		 * 
		 * employeeDetails.add(emp4); employeeDetails.add(emp3);
		 * employeeDetails.add(emp2); employeeDetails.add(emp1);
		 * employeeDetails.add(emp);
		 */

		System.out.println(employeeDetails);

		response.setEmployeeDetails(employeeDetails);
		response.setErrorCode(0);
		response.setErrorDesc("Success");

		return response;
	}

	public String insertNewEmployee(ArrayList<InsertEmployeeList> employeeList) {
		// TODO Auto-generated method stub
		return null;
	}

}
